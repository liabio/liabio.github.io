<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="liabio">
  
  
  
  
  <link rel="next" href="https://example.com/post/2019-5-15-kubernetes%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/" />
  <link rel="canonical" href="https://example.com/post/2019-5-21-etcd%E6%93%8D%E4%BD%9C/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
            | LeaveIt
       
  </title>
  <meta name="title" content=" | LeaveIt">
    
  
  
  
  
  
  
  
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/font/jianshu/iconfont.css">
  <link rel="stylesheet" href="/font/segmentfault/iconfont.css">
  <link rel="stylesheet" href="/font/weixingongzhonghao/iconfont.css">
  <link rel="stylesheet" href="/font/juejin/iconfont.css">
  <link rel="stylesheet" href="/font/zhihu/iconfont.css">
  <link rel="stylesheet" href="/font/cnblog/iconfont.css">
  <link rel="stylesheet" href="/font/csdn/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/example.com"
    },
    "articleSection" : "post",
    "name" : "",
    "headline" : "",
    "description" : "etcd操作 etcdctl安装 下载并解压二进制文件\ncurl -L https:\/\/github.com\/coreos\/etcd\/releases\/download\/v3.3.2\/etcd-v3.3.2-linux-amd64.tar.gz -o etcd-v3.3.2-linux-amd64.tar.gz tar zxf etcd-v3.3.2-linux-amd64.tar.gz  解压后是一些文档和两个二进制文件etcd和etcdctl。etcd是server端，etcdctl是客户端。\n将解压后的etcd和etcdctl移动到$GOPATH\/bin目录下，可以直接使用etcd和etcdctl命令\nmv etcd-v3.3.2-linux-amd64\/etcd* \/usr\/local\/bin\/  # 获取etcd节点成员列表 $ ETCDCTL_API=3 etcdctl --cacert=\/etc\/kubernetes\/pki\/etcd\/ca.crt --cert=\/etc\/kubernetes\/pki\/etcd\/peer.crt --key=\/etc\/kubernetes\/pki\/etcd\/peer.key member list -w=json | jq . { \x26quot;header\x26quot;: { \x26quot;cluster_id\x26quot;: 16127964494473114000, \x26quot;member_id\x26quot;: 10756017414160822000, \x26quot;raft_term\x26quot;: 3 }, \x26quot;members\x26quot;: [ { \x26quot;ID\x26quot;: 10756017414160822000, \x26quot;name\x26quot;: \x26quot;master-192.168.1.103\x26quot;, \x26quot;peerURLs\x26quot;: [ \x26quot;https:\/\/192.168.1.103:2380\x26quot; ], \x26quot;clientURLs\x26quot;: [ \x26quot;https:\/\/192.168.1.103:2379\x26quot; ] } ] } # 获取所有的key $ ETCDCTL_API=3 etcdctl --cacert=\/etc\/kubernetes\/pki\/etcd\/ca.crt --cert=\/etc\/kubernetes\/pki\/etcd\/peer.crt --key=\/etc\/kubernetes\/pki\/etcd\/peer.key get \x26quot;\x26quot; --prefix=true -w=json | jq .",
    "inLanguage" : "en-us",
    "author" : "liabio",
    "creator" : "liabio",
    "publisher": "liabio",
    "accountablePerson" : "liabio",
    "copyrightHolder" : "liabio",
    "copyrightYear" : "0001",
    "datePublished": "0001-01-01 00:00:00 \x2b0000 UTC",
    "dateModified" : "0001-01-01 00:00:00 \x2b0000 UTC",
    "url" : "https:\/\/example.com\/post\/2019-5-21-etcd%E6%93%8D%E4%BD%9C\/",
    "wordCount" : "910",
    "keywords" : [  "LeaveIt"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://example.com">LeaveIt</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://example.com">LeaveIt</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline"></h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://example.com" rel="author">liabio</a> with ♥ 
                <span class="post-time">
                on <time datetime=0001-01-01 itemprop="datePublished">January 1, 0001</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          

<h1 id="etcd操作">etcd操作</h1>

<p>etcdctl安装
下载并解压二进制文件</p>

<pre><code>curl -L https://github.com/coreos/etcd/releases/download/v3.3.2/etcd-v3.3.2-linux-amd64.tar.gz -o etcd-v3.3.2-linux-amd64.tar.gz
tar zxf etcd-v3.3.2-linux-amd64.tar.gz
</code></pre>

<p>解压后是一些文档和两个二进制文件etcd和etcdctl。etcd是server端，etcdctl是客户端。</p>

<p>将解压后的etcd和etcdctl移动到$GOPATH/bin目录下，可以直接使用etcd和etcdctl命令</p>

<pre><code>mv etcd-v3.3.2-linux-amd64/etcd* /usr/local/bin/
</code></pre>

<p><figure><img src="/images/ring.svg" data-sizes="auto" data-src="/img/etcd1.png" alt="" class="lazyload"><figcaption class="image-caption"></figcaption></figure></p>

<pre><code># 获取etcd节点成员列表
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key  member list -w=json | jq .
{
  &quot;header&quot;: {
    &quot;cluster_id&quot;: 16127964494473114000,
    &quot;member_id&quot;: 10756017414160822000,
    &quot;raft_term&quot;: 3
  },
  &quot;members&quot;: [
    {
      &quot;ID&quot;: 10756017414160822000,
      &quot;name&quot;: &quot;master-192.168.1.103&quot;,
      &quot;peerURLs&quot;: [
        &quot;https://192.168.1.103:2380&quot;
      ],
      &quot;clientURLs&quot;: [
        &quot;https://192.168.1.103:2379&quot;
      ]
    }
  ]
}

# 获取所有的key
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get &quot;&quot; --prefix=true  -w=json | jq .

# 获取前缀是/registry/namespaces/default的key：
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get /registry/namespaces/default --prefix=true -w=json | jq .
{
  &quot;header&quot;: {
    &quot;cluster_id&quot;: 16127964494473114000,
    &quot;member_id&quot;: 10756017414160822000,
    &quot;revision&quot;: 596049,
    &quot;raft_term&quot;: 3
  },
  &quot;kvs&quot;: [
    {
      &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGVmYXVsdA==&quot;,
      &quot;create_revision&quot;: 4,
      &quot;mod_revision&quot;: 4,
      &quot;version&quot;: 1,
      &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEl8KRQoHZGVmYXVsdBIAGgAiACokYjQzYzRkYzgtNzYzMS0xMWU5LWI0NTctMDAwYzI5NWRiMzg5MgA4AEIICJqs6uYFEAB6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&quot;
    }
  ],
  &quot;count&quot;: 1
}

# 设置liabuo1111的值为liabuo1111
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key put liabuo1111 libauo1111  -w=json | jq .
{
  &quot;header&quot;: {
    &quot;cluster_id&quot;: 16127964494473114000,
    &quot;member_id&quot;: 10756017414160822000,
    &quot;revision&quot;: 597761,
    &quot;raft_term&quot;: 3
  }
}

# 设置libauo11的值为libauo11
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key put liabuo11 libauo11  -w=json | jq .

# 精确查询liabuo11
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get liabuo11   -w=json | jq .
{
  &quot;header&quot;: {
    &quot;cluster_id&quot;: 16127964494473114000,
    &quot;member_id&quot;: 10756017414160822000,
    &quot;revision&quot;: 597769,
    &quot;raft_term&quot;: 3
  },
  &quot;kvs&quot;: [
    {
      &quot;key&quot;: &quot;bGlhYnVvMTE=&quot;,
      &quot;create_revision&quot;: 597611,
      &quot;mod_revision&quot;: 597611,
      &quot;version&quot;: 1,
      &quot;value&quot;: &quot;bGliYXVvMTE=&quot;
    }
  ],
  &quot;count&quot;: 1
}

# 前缀查询liabuo11,会查到两个
$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get liabuo11 --prefix=true  -w=json | jq .
{
  &quot;header&quot;: {
    &quot;cluster_id&quot;: 16127964494473114000,
    &quot;member_id&quot;: 10756017414160822000,
    &quot;revision&quot;: 597781,
    &quot;raft_term&quot;: 3
  },
  &quot;kvs&quot;: [
    {
      &quot;key&quot;: &quot;bGlhYnVvMTE=&quot;,
      &quot;create_revision&quot;: 597611,
      &quot;mod_revision&quot;: 597611,
      &quot;version&quot;: 1,
      &quot;value&quot;: &quot;bGliYXVvMTE=&quot;
    },
    {
      &quot;key&quot;: &quot;bGlhYnVvMTExMQ==&quot;,
      &quot;create_revision&quot;: 597761,
      &quot;mod_revision&quot;: 597761,
      &quot;version&quot;: 1,
      &quot;value&quot;: &quot;bGliYXVvMTExMQ==&quot;
    }
  ],
  &quot;count&quot;: 2
}

</code></pre>

<h2 id="使用etcdctl访问kubernetes数据">使用etcdctl访问kubernetes数据</h2>

<p>Kubenretes1.6中使用etcd V3版本的API，使用etcdctl直接ls的话只能看到/kube-centos一个路径。需要在命令前加上ETCDCTL_API=3这个环境变量才能看到kuberentes在etcd中保存的数据。</p>

<p>ETCDCTL_API=3 etcdctl get /registry/namespaces/default -w=json|python -m json.tool
如果是使用 kubeadm 创建的集群，在 Kubenretes 1.11 中，etcd 默认使用 tls ，这时你可以在 master 节点上使用以下命令来访问 etcd ：</p>

<pre><code>ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt \
--cert=/etc/kubernetes/pki/etcd/peer.crt \
--key=/etc/kubernetes/pki/etcd/peer.key \
get /registry/namespaces/default -w=json | jq .
</code></pre>

<p>-w指定输出格式
将得到这样的json的结果：</p>

<pre><code>{
    &quot;count&quot;: 1,
    &quot;header&quot;: {
        &quot;cluster_id&quot;: 12091028579527406772,
        &quot;member_id&quot;: 16557816780141026208,
        &quot;raft_term&quot;: 36,
        &quot;revision&quot;: 29253467
    },
    &quot;kvs&quot;: [
        {
            &quot;create_revision&quot;: 5,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGVmYXVsdA==&quot;,
            &quot;mod_revision&quot;: 5,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmIKSAoHZGVmYXVsdBIAGgAiACokZTU2YzMzMDgtMWVhOC0xMWU3LThjZDctZjRlOWQ0OWY4ZWQwMgA4AEILCIn4sscFEKOg9xd6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&quot;,
            &quot;version&quot;: 1
        }
    ]
}
</code></pre>

<p>使用&ndash;prefix可以看到所有的子目录，如查看集群中的namespace：</p>

<p>ETCDCTL_API=3 etcdctl get /registry/namespaces &ndash;prefix -w=json|python -m json.tool
输出结果中可以看到所有的namespace。</p>

<pre><code>{
    &quot;count&quot;: 8,
    &quot;header&quot;: {
        &quot;cluster_id&quot;: 12091028579527406772,
        &quot;member_id&quot;: 16557816780141026208,
        &quot;raft_term&quot;: 36,
        &quot;revision&quot;: 29253722
    },
    &quot;kvs&quot;: [
        {
            &quot;create_revision&quot;: 24310883,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvYXV0b21vZGVs&quot;,
            &quot;mod_revision&quot;: 24310883,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmQKSgoJYXV0b21vZGVsEgAaACIAKiQ1MjczOTU1ZC1iMzEyLTExZTctOTcwYy1mNGU5ZDQ5ZjhlZDAyADgAQgsI7fSWzwUQ6Jv1Z3oAEgwKCmt1YmVybmV0ZXMaCAoGQWN0aXZlGgAiAA==&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 21387676,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvYnJhbmQ=&quot;,
            &quot;mod_revision&quot;: 21387676,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmEKRwoFYnJhbmQSABoAIgAqJGNkZmQ1Y2NmLWExYzktMTFlNy05NzBjLWY0ZTlkNDlmOGVkMDIAOABCDAjR9qLOBRDYn83XAXoAEgwKCmt1YmVybmV0ZXMaCAoGQWN0aXZlGgAiAA==&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 5,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGVmYXVsdA==&quot;,
            &quot;mod_revision&quot;: 5,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmIKSAoHZGVmYXVsdBIAGgAiACokZTU2YzMzMDgtMWVhOC0xMWU3LThjZDctZjRlOWQ0OWY4ZWQwMgA4AEILCIn4sscFEKOg9xd6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 18504694,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvZGV2&quot;,
            &quot;mod_revision&quot;: 24310213,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmwKUgoDZGV2EgAaACIAKiQyOGRlMGVjNS04ZTEzLTExZTctOTcwYy1mNGU5ZDQ5ZjhlZDAyADgAQgwI89CezQUQ0v2fuQNaCwoEbmFtZRIDZGV2egASDAoKa3ViZXJuZXRlcxoICgZBY3RpdmUaACIA&quot;,
            &quot;version&quot;: 4
        },
        {
            &quot;create_revision&quot;: 10,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMva3ViZS1wdWJsaWM=&quot;,
            &quot;mod_revision&quot;: 10,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmcKTQoLa3ViZS1wdWJsaWMSABoAIgAqJGU1ZjhkY2I1LTFlYTgtMTFlNy04Y2Q3LWY0ZTlkNDlmOGVkMDIAOABCDAiJ+LLHBRDdrsDPA3oAEgwKCmt1YmVybmV0ZXMaCAoGQWN0aXZlGgAiAA==&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 2,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMva3ViZS1zeXN0ZW0=&quot;,
            &quot;mod_revision&quot;: 2,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEmYKTAoLa3ViZS1zeXN0ZW0SABoAIgAqJGU1NmFhMDVkLTFlYTgtMTFlNy04Y2Q3LWY0ZTlkNDlmOGVkMDIAOABCCwiJ+LLHBRDoq9ASegASDAoKa3ViZXJuZXRlcxoICgZBY3RpdmUaACIA&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 3774247,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvc3BhcmstY2x1c3Rlcg==&quot;,
            &quot;mod_revision&quot;: 3774247,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEoABCmYKDXNwYXJrLWNsdXN0ZXISABoAIgAqJDMyNjY3ZDVjLTM0YWMtMTFlNy1iZmJkLThhZjFlM2E3YzViZDIAOABCDAiA1cbIBRDU3YuAAVoVCgRuYW1lEg1zcGFyay1jbHVzdGVyegASDAoKa3ViZXJuZXRlcxoICgZBY3RpdmUaACIA&quot;,
            &quot;version&quot;: 1
        },
        {
            &quot;create_revision&quot;: 15212191,
            &quot;key&quot;: &quot;L3JlZ2lzdHJ5L25hbWVzcGFjZXMveWFybi1jbHVzdGVy&quot;,
            &quot;mod_revision&quot;: 15212191,
            &quot;value&quot;: &quot;azhzAAoPCgJ2MRIJTmFtZXNwYWNlEn0KYwoMeWFybi1jbHVzdGVyEgAaACIAKiQ2YWNhNjk1Yi03N2Y5LTExZTctYmZiZC04YWYxZTNhN2M1YmQyADgAQgsI1qiKzAUQkoqxDloUCgRuYW1lEgx5YXJuLWNsdXN0ZXJ6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&quot;,
            &quot;version&quot;: 1
        }
    ]
}
</code></pre>

<p>key的值是经过base64编码，需要解码后才能看到实际值，如：</p>

<pre><code>$ echo L3JlZ2lzdHJ5L25hbWVzcGFjZXMvYXV0b21vZGVs|base64 -d
/registry/namespaces/automodel
</code></pre>

<p>etcd中kubernetes的元数据
我们使用kubectl命令获取的kubernetes的对象状态实际上是保存在etcd中的，使用下面的脚本可以获取etcd中的所有kubernetes对象的key：</p>

<p>注意，我们使用了ETCD v3版本的客户端命令来访问etcd，以下etcd版本为3.2.24，k8s版本为1.13.2</p>

<pre><code>#!/bin/bash
# Get kubernetes keys from etcd
export ETCDCTL_API=3
keys=`ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get /registry --prefix -w json|jq .|grep key|cut -d &quot;:&quot; -f2|tr -d '&quot;'|tr -d &quot;,&quot;`
for x in $keys;do
  echo $x|base64 -d|sort
done
</code></pre>

<p>通过输出的结果我们可以看到kubernetes的原数据是按何种结构存储在etcd中的，输出结果如下所示：</p>

<pre><code>/registry/apiextensions.k8s.io/customresourcedefinitions/redisclusters.redis.middleware.hc.cn
/registry/apiregistration.k8s.io/apiservices/v1.
/registry/apiregistration.k8s.io/apiservices/v1.apps
/registry/apiregistration.k8s.io/apiservices/v1.authentication.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1.authorization.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1.autoscaling
/registry/apiregistration.k8s.io/apiservices/v1.batch
/registry/apiregistration.k8s.io/apiservices/v1.networking.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1.rbac.authorization.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1.storage.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1alpha1.redis.middleware.hc.cn
/registry/apiregistration.k8s.io/apiservices/v1beta1.admissionregistration.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.apiextensions.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.apps
/registry/apiregistration.k8s.io/apiservices/v1beta1.authentication.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.authorization.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.batch
/registry/apiregistration.k8s.io/apiservices/v1beta1.certificates.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.coordination.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.events.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.extensions
/registry/apiregistration.k8s.io/apiservices/v1beta1.policy
/registry/apiregistration.k8s.io/apiservices/v1beta1.rbac.authorization.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.scheduling.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta1.storage.k8s.io
/registry/apiregistration.k8s.io/apiservices/v1beta2.apps
/registry/apiregistration.k8s.io/apiservices/v2beta1.autoscaling
/registry/apiregistration.k8s.io/apiservices/v2beta2.autoscaling
/registry/clusterrolebindings/cluster-admin
/registry/clusterrolebindings/flannel
/registry/clusterrolebindings/kubeadm:kubelet-bootstrap
/registry/clusterrolebindings/kubeadm:node-autoapprove-bootstrap
/registry/clusterrolebindings/kubeadm:node-autoapprove-certificate-rotation
/registry/clusterrolebindings/kubeadm:node-proxier
/registry/clusterrolebindings/system:aws-cloud-provider
/registry/clusterrolebindings/system:basic-user
/registry/clusterrolebindings/system:controller:attachdetach-controller
/registry/clusterrolebindings/system:controller:certificate-controller
/registry/clusterrolebindings/system:controller:clusterrole-aggregation-controller
/registry/clusterrolebindings/system:controller:cronjob-controller
/registry/clusterrolebindings/system:controller:daemon-set-controller
/registry/clusterrolebindings/system:controller:deployment-controller
/registry/clusterrolebindings/system:controller:disruption-controller
/registry/clusterrolebindings/system:controller:endpoint-controller
/registry/clusterrolebindings/system:controller:expand-controller
/registry/clusterrolebindings/system:controller:generic-garbage-collector
/registry/clusterrolebindings/system:controller:horizontal-pod-autoscaler
/registry/clusterrolebindings/system:controller:job-controller
/registry/clusterrolebindings/system:controller:namespace-controller
/registry/clusterrolebindings/system:controller:node-controller
/registry/clusterrolebindings/system:controller:persistent-volume-binder
/registry/clusterrolebindings/system:controller:pod-garbage-collector
/registry/clusterrolebindings/system:controller:pv-protection-controller
/registry/clusterrolebindings/system:controller:pvc-protection-controller
/registry/clusterrolebindings/system:controller:replicaset-controller
/registry/clusterrolebindings/system:controller:replication-controller
/registry/clusterrolebindings/system:controller:resourcequota-controller
/registry/clusterrolebindings/system:controller:route-controller
/registry/clusterrolebindings/system:controller:service-account-controller
/registry/clusterrolebindings/system:controller:service-controller
/registry/clusterrolebindings/system:controller:statefulset-controller
/registry/clusterrolebindings/system:controller:ttl-controller
/registry/clusterrolebindings/system:coredns
/registry/clusterrolebindings/system:discovery
/registry/clusterrolebindings/system:kube-controller-manager
/registry/clusterrolebindings/system:kube-dns
/registry/clusterrolebindings/system:kube-scheduler
/registry/clusterrolebindings/system:node
/registry/clusterrolebindings/system:node-proxier
/registry/clusterrolebindings/system:volume-scheduler
/registry/clusterroles/admin
/registry/clusterroles/cluster-admin
/registry/clusterroles/edit
/registry/clusterroles/flannel
/registry/clusterroles/system:aggregate-to-admin
/registry/clusterroles/system:aggregate-to-edit
/registry/clusterroles/system:aggregate-to-view
/registry/clusterroles/system:auth-delegator
/registry/clusterroles/system:aws-cloud-provider
/registry/clusterroles/system:basic-user
/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:nodeclient
/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
/registry/clusterroles/system:controller:attachdetach-controller
/registry/clusterroles/system:controller:certificate-controller
/registry/clusterroles/system:controller:clusterrole-aggregation-controller
/registry/clusterroles/system:controller:cronjob-controller
/registry/clusterroles/system:controller:daemon-set-controller
/registry/clusterroles/system:controller:deployment-controller
/registry/clusterroles/system:controller:disruption-controller
/registry/clusterroles/system:controller:endpoint-controller
/registry/clusterroles/system:controller:expand-controller
/registry/clusterroles/system:controller:generic-garbage-collector
/registry/clusterroles/system:controller:horizontal-pod-autoscaler
/registry/clusterroles/system:controller:job-controller
/registry/clusterroles/system:controller:namespace-controller
/registry/clusterroles/system:controller:node-controller
/registry/clusterroles/system:controller:persistent-volume-binder
/registry/clusterroles/system:controller:pod-garbage-collector
/registry/clusterroles/system:controller:pv-protection-controller
/registry/clusterroles/system:controller:pvc-protection-controller
/registry/clusterroles/system:controller:replicaset-controller
/registry/clusterroles/system:controller:replication-controller
/registry/clusterroles/system:controller:resourcequota-controller
/registry/clusterroles/system:controller:route-controller
/registry/clusterroles/system:controller:service-account-controller
/registry/clusterroles/system:controller:service-controller
/registry/clusterroles/system:controller:statefulset-controller
/registry/clusterroles/system:controller:ttl-controller
/registry/clusterroles/system:coredns
/registry/clusterroles/system:csi-external-attacher
/registry/clusterroles/system:csi-external-provisioner
/registry/clusterroles/system:discovery
/registry/clusterroles/system:heapster
/registry/clusterroles/system:kube-aggregator
/registry/clusterroles/system:kube-controller-manager
/registry/clusterroles/system:kube-dns
/registry/clusterroles/system:kube-scheduler
/registry/clusterroles/system:kubelet-api-admin
/registry/clusterroles/system:node
/registry/clusterroles/system:node-bootstrapper
/registry/clusterroles/system:node-problem-detector
/registry/clusterroles/system:node-proxier
/registry/clusterroles/system:persistent-volume-provisioner
/registry/clusterroles/system:volume-scheduler
/registry/clusterroles/view
/registry/configmaps/kube-public/cluster-info
/registry/configmaps/kube-system/coredns
/registry/configmaps/kube-system/extension-apiserver-authentication
/registry/configmaps/kube-system/kube-flannel-cfg
/registry/configmaps/kube-system/kube-proxy
/registry/configmaps/kube-system/kubeadm-config
/registry/configmaps/kube-system/kubelet-config-1.13
/registry/controllerrevisions/kube-system/example000-redis-cluster-77777b9d87
/registry/controllerrevisions/kube-system/example000-redis-cluster-7bddc7968
/registry/controllerrevisions/kube-system/example000-redis-cluster-b46d9796b
/registry/controllerrevisions/kube-system/example000-redis-cluster-b68878567
/registry/controllerrevisions/kube-system/kube-flannel-ds-amd64-6fb846cf69
/registry/controllerrevisions/kube-system/kube-flannel-ds-amd64-7cd7fc57bf
/registry/controllerrevisions/kube-system/kube-proxy-f78c74d59
/registry/daemonsets/kube-system/kube-flannel-ds-amd64
/registry/daemonsets/kube-system/kube-proxy
/registry/deployments/kube-system/coredns
/registry/events/kube-system/example000-redis-cluster.159fd16445dfaa02
/registry/masterleases/192.168.1.103
/registry/minions/master-192.168.1.103
/registry/namespaces/default
/registry/namespaces/kube-public
/registry/namespaces/kube-system
/registry/pods/kube-system/coredns-78d4cf999f-7sf7h
/registry/pods/kube-system/coredns-78d4cf999f-qfwcz
/registry/pods/kube-system/etcd-master-192.168.1.103
/registry/pods/kube-system/kube-apiserver-master-192.168.1.103
/registry/pods/kube-system/kube-controller-manager-master-192.168.1.103
/registry/pods/kube-system/kube-flannel-ds-amd64-sp9kk
/registry/pods/kube-system/kube-proxy-ckt7x
/registry/pods/kube-system/kube-scheduler-master-192.168.1.103
/registry/podsecuritypolicy/psp.flannel.unprivileged
/registry/priorityclasses/system-cluster-critical
/registry/priorityclasses/system-node-critical
/registry/ranges/serviceips
/registry/ranges/servicenodeports
/registry/redis.middleware.hc.cn/redisclusters/kube-system/example000-redis-cluster
/registry/replicasets/kube-system/coredns-78d4cf999f
/registry/rolebindings/kube-public/kubeadm:bootstrap-signer-clusterinfo
/registry/rolebindings/kube-public/system:controller:bootstrap-signer
/registry/rolebindings/kube-system/kube-proxy
/registry/rolebindings/kube-system/kubeadm:kubelet-config-1.13
/registry/rolebindings/kube-system/kubeadm:nodes-kubeadm-config
/registry/rolebindings/kube-system/system::leader-locking-kube-controller-manager
/registry/rolebindings/kube-system/system::leader-locking-kube-scheduler
/registry/rolebindings/kube-system/system:controller:bootstrap-signer
/registry/rolebindings/kube-system/system:controller:cloud-provider
/registry/rolebindings/kube-system/system:controller:token-cleaner
/registry/roles/kube-public/kubeadm:bootstrap-signer-clusterinfo
/registry/roles/kube-public/system:controller:bootstrap-signer
/registry/roles/kube-system/extension-apiserver-authentication-reader
/registry/roles/kube-system/kube-proxy
/registry/roles/kube-system/kubeadm:kubelet-config-1.13
/registry/roles/kube-system/kubeadm:nodes-kubeadm-config
/registry/roles/kube-system/system::leader-locking-kube-controller-manager
/registry/roles/kube-system/system::leader-locking-kube-scheduler
/registry/roles/kube-system/system:controller:bootstrap-signer
/registry/roles/kube-system/system:controller:cloud-provider
/registry/roles/kube-system/system:controller:token-cleaner
/registry/secrets/default/default-token-nm6fz
/registry/secrets/kube-public/default-token-tvxhr
/registry/secrets/kube-system/attachdetach-controller-token-th9ds
/registry/secrets/kube-system/bootstrap-signer-token-5gp9z
/registry/secrets/kube-system/certificate-controller-token-9pp4j
/registry/secrets/kube-system/clusterrole-aggregation-controller-token-hxsnv
/registry/secrets/kube-system/coredns-token-tmvjm
/registry/secrets/kube-system/cronjob-controller-token-9g9hf
/registry/secrets/kube-system/daemon-set-controller-token-nblgv
/registry/secrets/kube-system/default-token-6xjf2
/registry/secrets/kube-system/deployment-controller-token-45vdd
/registry/secrets/kube-system/disruption-controller-token-2vswp
/registry/secrets/kube-system/endpoint-controller-token-7nch6
/registry/secrets/kube-system/expand-controller-token-tf679
/registry/secrets/kube-system/flannel-token-dv9ql
/registry/secrets/kube-system/generic-garbage-collector-token-cs7lr
/registry/secrets/kube-system/horizontal-pod-autoscaler-token-68s8k
/registry/secrets/kube-system/job-controller-token-xt4c4
/registry/secrets/kube-system/kube-proxy-token-szvhf
/registry/secrets/kube-system/namespace-controller-token-lw656
/registry/secrets/kube-system/node-controller-token-d7l7x
/registry/secrets/kube-system/persistent-volume-binder-token-vwgs5
/registry/secrets/kube-system/pod-garbage-collector-token-hzlfs
/registry/secrets/kube-system/pv-protection-controller-token-w7x5z
/registry/secrets/kube-system/pvc-protection-controller-token-8qpbm
/registry/secrets/kube-system/replicaset-controller-token-spx99
/registry/secrets/kube-system/replication-controller-token-4fjd2
/registry/secrets/kube-system/resourcequota-controller-token-52j9h
/registry/secrets/kube-system/service-account-controller-token-xzmfh
/registry/secrets/kube-system/service-controller-token-86nv9
/registry/secrets/kube-system/statefulset-controller-token-txbdl
/registry/secrets/kube-system/token-cleaner-token-b9nn9
/registry/secrets/kube-system/ttl-controller-token-m7dts
/registry/serviceaccounts/default/default
/registry/serviceaccounts/kube-public/default
/registry/serviceaccounts/kube-system/attachdetach-controller
/registry/serviceaccounts/kube-system/bootstrap-signer
/registry/serviceaccounts/kube-system/certificate-controller
/registry/serviceaccounts/kube-system/clusterrole-aggregation-controller
/registry/serviceaccounts/kube-system/coredns
/registry/serviceaccounts/kube-system/cronjob-controller
/registry/serviceaccounts/kube-system/daemon-set-controller
/registry/serviceaccounts/kube-system/default
/registry/serviceaccounts/kube-system/deployment-controller
/registry/serviceaccounts/kube-system/disruption-controller
/registry/serviceaccounts/kube-system/endpoint-controller
/registry/serviceaccounts/kube-system/expand-controller
/registry/serviceaccounts/kube-system/flannel
/registry/serviceaccounts/kube-system/generic-garbage-collector
/registry/serviceaccounts/kube-system/horizontal-pod-autoscaler
/registry/serviceaccounts/kube-system/job-controller
/registry/serviceaccounts/kube-system/kube-proxy
/registry/serviceaccounts/kube-system/namespace-controller
/registry/serviceaccounts/kube-system/node-controller
/registry/serviceaccounts/kube-system/persistent-volume-binder
/registry/serviceaccounts/kube-system/pod-garbage-collector
/registry/serviceaccounts/kube-system/pv-protection-controller
/registry/serviceaccounts/kube-system/pvc-protection-controller
/registry/serviceaccounts/kube-system/replicaset-controller
/registry/serviceaccounts/kube-system/replication-controller
/registry/serviceaccounts/kube-system/resourcequota-controller
/registry/serviceaccounts/kube-system/service-account-controller
/registry/serviceaccounts/kube-system/service-controller
/registry/serviceaccounts/kube-system/statefulset-controller
/registry/serviceaccounts/kube-system/token-cleaner
/registry/serviceaccounts/kube-system/ttl-controller
/registry/services/endpoints/default/kubernetes
/registry/services/endpoints/kube-system/example000-redis-cluster
/registry/services/endpoints/kube-system/kube-controller-manager
/registry/services/endpoints/kube-system/kube-dns
/registry/services/endpoints/kube-system/kube-scheduler
/registry/services/specs/default/kubernetes
/registry/services/specs/kube-system/example000-redis-cluster
/registry/services/specs/kube-system/kube-dns
/registry/statefulsets/kube-system/example000-redis-cluster
</code></pre>

<pre><code># 获取ETCD中的所有数据
# --prefix 表示获取所有key值头为某个字符串的数据， 由于传入的是&quot;&quot;，所以会匹配所有的值
# --keys-only 表示只返回key而不返回value
# 对输出的结果使用grep过滤掉空行
/$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get &quot;&quot; --prefix --keys-only |grep -Ev &quot;^$&quot;

# 总共有240条记录
/$ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/peer.crt --key=/etc/kubernetes/pki/etcd/peer.key get &quot;&quot; --prefix --keys-only |grep -Ev &quot;^$&quot; |wc -l
</code></pre>

<p>我们可以看到所有的Kuberentes的所有元数据都保存在/registry目录下，下一层就是API对象类型（复数形式），再下一层是namespace，最后一层是对象的名字。</p>

<p>以下是etcd中存储的kubernetes所有的元数据类型：</p>

<pre><code>ThirdPartyResourceData
apiextensions.k8s.io
apiregistration.k8s.io
certificatesigningrequests
clusterrolebindings
clusterroles
configmaps
controllerrevisions
controllers
daemonsets
deployments
events
horizontalpodautoscalers
ingress
limitranges
minions
monitoring.coreos.com
namespaces
persistentvolumeclaims
persistentvolumes
poddisruptionbudgets
pods
ranges
replicasets
resourcequotas
rolebindings
roles
secrets
serviceaccounts
services
statefulsets
storageclasses
thirdpartyresources
</code></pre>

<p>restapi简单使用
v2版本
calico使用的是v2版本的api。</p>

<p>可以使用/etc/ssl/etcd/ssl下的k8s集群的etcd证书也可以使用/etc/calico/certs/下calico自己的etcd证书。</p>

<p>获取etcd member列表：</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;ca-file=/etc/ssl/etcd/ssl/ca.pem &ndash;cert-file=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key-file=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem member list</p>

<p>查看 /calico节点</p>

<p>ETCDCTL_API=2 etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;ca-file=/etc/ssl/etcd/ssl/ca.pem &ndash;cert-file=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key-file=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem ls /calico</p>

<p>v3版本
k8s会使用etcd v3版本的API记录数据。而默认etcdctl是使用v2版本的API，查看不到v3的数据。设置环境变量ETCDCTL_API=3后就OK了：</p>

<p>export ETCDCTL_API=3       #或者在etcdctl前面加上这个</p>

<p>获取etcd member列表：</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;cacert=/etc/ssl/etcd/ssl/ca.pem &ndash;cert=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem member list</p>

<p>获取所有key：</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;cacert=/etc/ssl/etcd/ssl/ca.pem &ndash;cert=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem get &ldquo;&rdquo; &ndash;prefix=true</p>

<p>获取前缀是/registry/pods/kube-system/prometheus的key：</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;cacert=/etc/ssl/etcd/ssl/ca.pem &ndash;cert=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem get /registry/pods/kube-system/prometheus &ndash;prefix=true</p>

<p>获取具体key:</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;cacert=/etc/ssl/etcd/ssl/ca.pem &ndash;cert=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem get /registry/pods/kube-system/prometheus-c78dbd66d-hkfcf （&ndash;prefix=true）</p>

<p>删除具体key:</p>

<p>etcdctl &ndash;endpoints=<a href="https://10.142.233.80:2379" rel="nofollow noreferrer" target="_blank">https://10.142.233.80:2379</a> &ndash;cacert=/etc/ssl/etcd/ssl/ca.pem &ndash;cert=/etc/ssl/etcd/ssl/node-10.142.233.80.pem &ndash;key=/etc/ssl/etcd/ssl/node-10.142.233.80-key.pem del /registry/pods/kube-system/prometheus-c78dbd66d-hkfcf</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>liabio </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://example.com/post/2019-5-21-etcd%E6%93%8D%E4%BD%9C/>https://example.com/post/2019-5-21-etcd%E6%93%8D%E4%BD%9C/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://example.com">home</a></span>
        </section>
    </div>

    <div class="post-nav">
         
        
        <a href="https://example.com/post/2019-5-15-kubernetes%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/" class="next" rel="next" title="">&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2011 - 2019</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://example.com">liabio</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
